<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#081423">
<link rel="apple-touch-icon" href="./icon-192.png">
<title>Predenuncia · Denunciante</title>
<style>
  :root{
    /* Fondo tipo “glass” azul petróleo (alineado con Panel Policía) */
    --bg0:#081423;
    --bg1:#0b1e2f;
    --bg2:#0a2233;

    /* Superficies */
    --card: rgba(255,255,255,.06);
    --card2: rgba(255,255,255,.10);

    /* Bordes y texto */
    --edge: rgba(255,255,255,.10);
    --edge2: rgba(255,255,255,.14);
    --txt: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.62);

    /* Acentos */
    --acc:#3b82f6;
    --ok:#22c55e;
    --warn:#f59e0b;
    --danger:#ef4444;

    /* Labels (dorado) */
    --label:#d6b06a;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--txt);
    background:
      radial-gradient(1200px 700px at 20% -10%, rgba(10,132,255,.18), transparent 60%),
      radial-gradient(900px 600px at 90% 10%, rgba(52,199,89,.10), transparent 55%),
      linear-gradient(180deg, #0b0f14, #0a0d12);
    min-height:100vh;
  }

  .wrap{max-width:1050px;margin:0 auto;padding:22px 16px 26px}

  .card{
    background:var(--card);
    border:1px solid var(--edge);
    border-radius:18px;
    padding:14px;
    box-shadow:
      0 18px 46px rgba(0,0,0,.35),
      inset 0 1px 0 rgba(255,255,255,.06);
    backdrop-filter:blur(10px) saturate(130%);
    -webkit-backdrop-filter:blur(10px) saturate(130%);
  }

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:720px){.grid{grid-template-columns:1fr}}

  .h1{font-weight:900;font-size:18px;margin:0}
  .muted{color:var(--muted);font-size:12px}

  label{display:block;font-size:12px;color:var(--label);margin:10px 0 6px;font-weight:900;letter-spacing:.25px}

  input,select,textarea{
    width:100%;
    border:1px solid var(--edge2);
    border-radius:14px;
    background:rgba(255,255,255,.06);
    color:var(--txt);
    padding:12px;
    outline:none;
    font-size:13px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
  }
  input:focus,select:focus,textarea:focus{
    border-color: rgba(214,176,106,.55);
    box-shadow:
      0 0 0 3px rgba(214,176,106,.12),
      inset 0 1px 0 rgba(255,255,255,.04);
  }

  textarea{min-height:120px;resize:vertical}

  .btn{
    border:1px solid var(--edge);
    border-radius:12px;
    padding:12px 12px;
    background:rgba(59,130,246,.20);
    color:var(--label);
    font-weight:800;
    letter-spacing:.3px;
    cursor:pointer;
  }
  .btn:active{transform:translateY(1px)}

  .btn.ok{background:rgba(34,197,94,.18);color:var(--label)}
  .btn.danger{background:rgba(239,68,68,.16);color:var(--label)}
  .btn.secondary{background:rgba(255,255,255,.06);color:var(--label)}

  .hr{height:1px;background:var(--edge);margin:14px 0}

  .hidden{display:none!important}
  #boxFiliacion.isHidden{display:none!important}

  pre{
    white-space:pre-wrap;
    word-break:break-word;
    border:1px solid var(--edge);
    border-radius:12px;
    padding:12px;
    background:rgba(0,0,0,.12);
    font-size:12px;
  }

  .modalBack{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.78);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    overflow:auto;
  }
  .modal{
    width:min(720px,96vw);
    max-height:calc(100vh - 36px);
    overflow:auto;
    background:rgba(17,28,51,.96);
    border:1px solid var(--edge);
    border-radius:18px;
    padding:14px;
  }
  .modalHead{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .modalTitle{font-weight:900}

  .btn.small{padding:10px 12px;border-radius:10px}

  /* Evita el zoom al pulsar inputs en iPhone */
  @media(max-width:720px){
    .wrap{padding:16px 12px 22px}
    input,select,textarea{font-size:16px}
  }
  .wizard{display:flex;flex-direction:column;gap:12px}
  .step{display:none}
  /* El paso activo ocupa altura y centra contenido (píldoras) */
  .step.isActive{
    display:flex;
    flex-direction:column;
    justify-content:center;
    min-height:calc(100vh - 260px);
  }
  /* En el paso 0 solo se ve la filiación (arriba); no mostramos un panel centrado adicional */
  .wizard[data-step0="1"] .step[data-step="0"],
  .step[data-step="0"]{display:none !important;}
  @media(max-width:720px){
    .step.isActive{min-height:calc(100vh - 220px);}
  }

  /* Panel visible detrás de las opciones (no “flotando” sin contenedor) */
  .stepPanel{
    border:1px solid var(--edge);
    background:rgba(0,0,0,.14);
    border-radius:16px;
    padding:14px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
  }
  .stepTitle{font-weight:900;font-size:14px;margin:0 0 8px}
  .navRow{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-top:12px}
  .navRow .left{display:flex;gap:10px}
  .pill{min-width:110px}
  .progress{font-size:12px;color:var(--muted)}
  .choices{display:flex;flex-direction:column;gap:8px}
  .choices .btn{width:100%;text-align:left}

  /* Píldoras seleccionables */
  .choiceBtn{
    border:1px solid var(--edge);
    border-radius:999px;
    padding:12px 14px;
    background:rgba(255,255,255,.06);
    color:var(--txt);
    font-weight:800;
    letter-spacing:.3px;
    cursor:pointer;
  }
  .choiceBtn.isPicked{
    border-color:rgba(59,130,246,.75);
    background:rgba(59,130,246,.22);
  }
  /* Píldoras: una debajo de otra, centradas */
  .choices.pills{flex-direction:column;gap:10px;align-items:stretch}
  .choices.pills .choiceBtn{width:100%;text-align:center}
  .choices.pills{
    max-width:560px;
    margin:0 auto;
  }

  /* Evita el zoom al pulsar inputs en iPhone */
  @media(max-width:720px){
    input,select,textarea{font-size:16px}
  }

</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="h1">Predenuncia</div>
        <div class="muted" id="metaLine" style="display:none"></div>
      </div>
    </div>

    <div class="hr"></div>

    <div id="boxFiliacion">
      <div class="h1" style="font-size:14px">Datos de filiación</div>

      <div class="grid">
        <div>
          <label>Nombre</label>
          <input id="fNombre" autocomplete="given-name" />
        </div>
        <div>
          <label>Apellidos</label>
          <input id="fApellidos" autocomplete="family-name" />
        </div>

        <div>
          <label>Tipo documento</label>
          <select id="fTipoDoc">
            <option>DNI</option><option>NIE</option><option>PASAPORTE</option><option>OTRO</option>
          </select>
        </div>
        <div>
          <label>Nº documento</label>
          <input id="fNumDoc" />
        </div>

        <div>
          <label>Nacionalidad</label>
          <input id="fNac" placeholder="ESPAÑA" />
          <div class="choices pills" id="nacPills" style="margin-top:8px"></div>
        </div>
        <div>
          <label>Fecha nacimiento</label>
          <input id="fNacFecha" type="date" />
        </div>

        <div>
          <label>Lugar nacimiento (texto)</label>
          <input id="fNacLugar" placeholder="Municipio, Provincia, País" />
        </div>
        <div>
          <label>Teléfono</label>
          <input id="fTel" inputmode="numeric" />
        </div>

        <div style="grid-column:1/-1">
          <label>Domicilio (texto)</label>
          <input id="fDom" placeholder="Calle, número, municipio, provincia" />
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="wizard" id="wizard" data-step0="1">
      <div class="progress" id="wizProgress">—</div>

      <!-- Pasos dinámicos (1 pregunta por pantalla) -->
      <div id="dynSteps"></div>

      <div class="navRow">
        <div class="left">
          <button class="btn secondary pill" id="btnPrev" type="button">ATRÁS</button>
        </div>
        <div class="left">
          <button class="btn pill" id="btnNext" type="button">SIGUIENTE</button>
          <button class="btn ok pill" id="btnFinish" type="button" style="display:none">FINALIZAR</button>
        </div>
      </div>

      <div class="status" id="wizStatus"></div>
    </div>

    <div class="row" style="justify-content:flex-end;display:none">
      <button class="btn ok" id="btnFinalizar" type="button">FINALIZAR</button>
    </div>

    <div class="hr"></div>
    <div class="muted" id="doneMsg" style="display:none">Formulario finalizado y enviado.</div>
  </div>
</div>

<div class="modalBack" id="objsBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle">Objetos</div>
      <button class="btn small secondary" id="btnCloseObjs" type="button">Cerrar</button>
    </div>

    <div class="muted" style="margin-top:8px">Añade objetos con +. Solo: tipo, cantidad, valor en euros.</div>

    <div id="objsList" style="margin-top:10px;display:flex;flex-direction:column;gap:10px"></div>

    <div class="row" style="justify-content:space-between;margin-top:12px">
      <button class="btn secondary" id="btnAddObj" type="button">+</button>
      <button class="btn ok" id="btnSaveObjs" type="button">GUARDAR</button>
    </div>
  </div>
</div>


<script type="module">
import { db, serverTimestamp } from "./firebase.js";
import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const $ = (id)=>document.getElementById(id);
const qs = new URLSearchParams(location.search);
const token = (qs.get("token")||"").trim();
const tipo = (qs.get("tipo")||"PATRIMONIO").trim().toUpperCase();

// =============================
// CONFIG: Preguntas por tipo
// =============================
// Para añadir otro grupo delictivo: crea una nueva entrada en QUESTION_SETS.
// Cada pregunta es 1 pantalla.
const QUESTION_SETS = {
  "PATRIMONIO": [
    { key:"calidad_denunciante", title:"Calidad del denunciante", type:"select", options:[
      "PERJUDICADO",
      "REPRESENTANTE LEGAL",
      "EMPLEADO DE COMERCIO AFECTADO"
    ]},
    { key:"conocimiento_hecho", title:"Tipo de conocimiento del hecho", type:"select", options:[
      "TESTIGO DIRECTO",
      "POR TERCERAS PERSONAS",
      "CÁMARAS DE SEGURIDAD",
      "TRAS COMPROBAR PROPIEDAD FALTANTE"
    ]},
    { key:"fecha", title:"Fecha", type:"date" },
    { key:"hora", title:"Hora", type:"time" },
    { key:"lugar", title:"Lugar (texto corto)", type:"text", placeholder:"Calle / establecimiento / municipio" },
    { key:"interaccion_autor", title:"Interacción con autor/es", type:"select", options:[
      "NO",
      "SI, COMUNICACION",
      "SI, FORCEJEO/AGRESION"
    ]},
    { key:"autor_retenido", title:"Autor retenido en el lugar", type:"select", options:["SI","NO"] },
    { key:"lesiones", title:"Presenta lesiones", type:"select", options:["NO","SI"] },
    { key:"parte_medico", title:"Si lesiones: ¿aporta parte/informe médico?", type:"select", options:["NO","SI"],
      when:(st)=> (st.lesiones === "SI")
    },
    { key:"camaras", title:"¿Hay cámaras de seguridad?", type:"select", options:[
      "NO",
      "SI, LAS APORTA CON LA DENUNCIANTE",
      "SI, LAS APORTARÁ EN SEDE JUDICIAL",
      "SI, FACILITA INFORMACION PARA SU GESTION"
    ]},
    { key:"camaras_detalle", title:"Detalle cámaras (solo si facilita info)", type:"text", placeholder:"Establecimiento, contacto, ubicación, horario...",
      when:(st)=> (st.camaras === "SI, FACILITA INFORMACION PARA SU GESTION")
    },
    { key:"objetos", title:"Objetos", type:"objects" },
    { key:"resumen", title:"Breve resumen de los hechos", type:"textarea", placeholder:"2-6 líneas. Sin detalles del autor (ya está detenido).", max:900 }
  ]
};

function getQuestionsFor(tipo){
  return QUESTION_SETS[tipo] || QUESTION_SETS["PATRIMONIO"];
}

// =============================
// Estado wizard
// =============================
let objetosState = [];
const wiz = {
  idx: 0,                 // 0 = filiación (pantalla fija)
  steps: [],              // [{q, el, inputEl?}]
  st: {                   // respuestas
    calidad_denunciante:"",
    conocimiento_hecho:"",
    fecha:"",
    hora:"",
    lugar:"",
    interaccion_autor:"",
    autor_retenido:"",
    lesiones:"NO",
    parte_medico:"NO",
    camaras:"NO",
    camaras_detalle:"",
    resumen:""
  }
};

function storageKey(){ return "pred_"+tipo+"_"+token; }

function readFiliacion(){
  return {
    "Nombre": ($("fNombre").value||"").trim(),
    "Apellidos": ($("fApellidos").value||"").trim(),
    "Tipo de documento": ($("fTipoDoc").value||"").trim(),
    "Nº Documento": ($("fNumDoc").value||"").trim(),
    "Nacionalidad": ($("fNac").value||"").trim(),
    "Fecha de nacimiento": ($("fNacFecha").value||"").trim(),
    "Lugar de nacimiento": ($("fNacLugar").value||"").trim(),
    "Domicilio": ($("fDom").value||"").trim(),
    "Teléfono": ($("fTel").value||"").trim(),
    "Condición": (wiz.st.calidad_denunciante||"").trim()
  };
}

function buildPayload(){
  const lesiones = (wiz.st.lesiones||"NO");
  const cam = (wiz.st.camaras||"NO");
  return {
    meta: { tipo_delictivo: tipo, token, version: 2, createdAt: new Date().toISOString() },
    filiacion: readFiliacion(),
    hechos: {
      calidad_denunciante: (wiz.st.calidad_denunciante||"").trim(),
      conocimiento_hecho: (wiz.st.conocimiento_hecho||"").trim(),
      fecha: (wiz.st.fecha||"").trim(),
      hora: (wiz.st.hora||"").trim(),
      lugar: (wiz.st.lugar||"").trim(),
      interaccion_autor: (wiz.st.interaccion_autor||"").trim(),
      autor_retenido: (wiz.st.autor_retenido||"").trim(),
      lesiones: lesiones,
      parte_medico: (lesiones === "SI") ? (wiz.st.parte_medico||"NO") : "NO",
      camaras: cam,
      camaras_detalle: (cam === "SI, FACILITA INFORMACION PARA SU GESTION") ? (wiz.st.camaras_detalle||"").trim() : "",
      objetos: objetosState.slice(),
      resumen: (wiz.st.resumen||"").trim()
    }
  };
}

function shouldShowQuestion(q){
  if (typeof q.when === "function"){
    try{ return !!q.when(wiz.st); }catch(_){ return false; }
  }
  return true;
}

function setStatus(t){
  const el = $("wizStatus");
  if (el) el.textContent = t || "";
}

// =============================
// Render pasos dinámicos
// =============================
function makeStepEl(q){
  const wrap = document.createElement("div");
  wrap.className = "step";
  wrap.dataset.key = q.key;

  const title = document.createElement("div");
  title.className = "stepTitle";
  title.textContent = q.title;
  wrap.appendChild(title);

  let inputEl = null;

  if (q.type === "select"){
    const panel = document.createElement("div");
    panel.className = "stepPanel";

    const box = document.createElement("div");
    box.className = "choices pills";

    const current = (wiz.st[q.key] || "").trim();
    const def = (q.options && q.options[0]) ? q.options[0] : "";
    const initial = current || def;
    if (!wiz.st[q.key] && initial) wiz.st[q.key] = initial;

    for (const opt of (q.options||[])){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "choiceBtn";
      b.textContent = opt;
      b.dataset.value = opt;
      b.classList.toggle("isPicked", opt === wiz.st[q.key]);
      b.addEventListener("click", ()=>{
        wiz.st[q.key] = opt;
        // refresca resaltado
        box.querySelectorAll(".choiceBtn").forEach(x=>x.classList.toggle("isPicked", x.dataset.value === opt));
      });
      box.appendChild(b);
    }

    panel.appendChild(box);
    wrap.appendChild(panel);
    inputEl = box.querySelector(".choiceBtn.isPicked") || box.querySelector(".choiceBtn") || null;
  }
function renderNacPills(){
  const host = document.getElementById("nacPills");
  const inp = document.getElementById("fNac");
  if (!host || !inp) return;

  const opts = ["ESPAÑA","FRANCIA","PORTUGAL","MARRUECOS","RUMANÍA"];
  host.innerHTML = "";

  const pick = (v)=>{
    inp.value = v;
    host.querySelectorAll(".choiceBtn").forEach(x=>x.classList.toggle("isPicked", x.dataset.value === v));
  };

  for (const opt of opts){
    const b = document.createElement("button");
    b.type = "button";
    b.className = "choiceBtn";
    b.textContent = opt;
    b.dataset.value = opt;
    b.addEventListener("click", ()=> pick(opt));
    host.appendChild(b);
  }

  // resalta si ya hay valor
  const cur = (inp.value||"").trim().toUpperCase();
  if (cur) pick(cur);
}

  if (q.type === "date" || q.type === "time"){
    const inp = document.createElement("input");
    inp.type = q.type;
    inp.id = "q_"+q.key;
    inp.value = wiz.st[q.key] || "";
    inp.addEventListener("input", ()=>{ wiz.st[q.key] = inp.value; });
    wrap.appendChild(inp);
    inputEl = inp;
  }

  if (q.type === "text"){
    const inp = document.createElement("input");
    inp.type = "text";
    inp.id = "q_"+q.key;
    inp.placeholder = q.placeholder || "";
    inp.value = wiz.st[q.key] || "";
    inp.addEventListener("input", ()=>{ wiz.st[q.key] = inp.value; });
    wrap.appendChild(inp);
    inputEl = inp;
  }

  if (q.type === "textarea"){
    const ta = document.createElement("textarea");
    ta.id = "q_"+q.key;
    ta.placeholder = q.placeholder || "";
    if (q.max) ta.maxLength = q.max;
    ta.value = wiz.st[q.key] || "";
    ta.addEventListener("input", ()=>{ wiz.st[q.key] = ta.value; });
    wrap.appendChild(ta);
    inputEl = ta;

    if (q.max){
      const m = document.createElement("div");
      m.className = "muted";
      m.textContent = `Máx ${q.max} caracteres.`;
      wrap.appendChild(m);
    }
  }

  if (q.type === "objects"){
    const row = document.createElement("div");
    row.className = "row";
    row.style.justifyContent = "space-between";

    const b = document.createElement("button");
    b.className = "btn secondary";
    b.type = "button";
    b.id = "q_objBtn";
    b.textContent = "AÑADIR / EDITAR OBJETOS";
    b.addEventListener("click", openObjs);

    const c = document.createElement("div");
    c.className = "muted";
    c.id = "q_objCount";
    c.textContent = String(objetosState.length);

    row.appendChild(b);
    row.appendChild(c);
    wrap.appendChild(row);

    const hint = document.createElement("div");
    hint.className = "muted";
    hint.style.marginTop = "8px";
    hint.textContent = "Añade objetos con +. Solo: tipo, cantidad, valor en euros.";
    wrap.appendChild(hint);
  }

  return { el: wrap, inputEl };
}

function renderWizard(){
  const dyn = $("dynSteps");
  dyn.innerHTML = "";

  const qs = getQuestionsFor(tipo);
  wiz.steps = [];

  for (const q of qs){
    const { el, inputEl } = makeStepEl(q);
    dyn.appendChild(el);
    wiz.steps.push({ q, el, inputEl });
  }

  updateStepUI(true);
}

function totalVisibleSteps(){
  // paso 0 (filiación) + visibles de preguntas
  let n = 1;
  for (const s of wiz.steps){
    if (shouldShowQuestion(s.q)) n++;
  }
  return n;
}

function visibleStepIndices(){
  // índices lógicos: 0=filiación, 1..N preguntas visibles en orden
  const out = [0];
  let k = 1;
  for (const s of wiz.steps){
    if (shouldShowQuestion(s.q)) out.push(k);
    k++;
  }
  return out;
}

function logicalToRealIndex(logicalIdx){
  // logicalIdx: 0=filiación; 1.. = orden de preguntas (incluye ocultas)
  // Aquí usamos wiz.idx como índice REAL: 0=filiación, 1..=posición en wiz.steps
  // Mantendremos wiz.idx como REAL.
  return logicalIdx;
}

function firstRealStep(){ return 0; }
function lastRealStep(){ return wiz.steps.length; }

function isRealStepVisible(realIdx){
  if (realIdx === 0) return true;
  const s = wiz.steps[realIdx-1];
  if (!s) return false;
  return shouldShowQuestion(s.q);
}

function nextVisibleReal(from){
  for (let i = from+1; i <= lastRealStep(); i++){
    if (isRealStepVisible(i)) return i;
  }
  return null;
}

function prevVisibleReal(from){
  for (let i = from-1; i >= firstRealStep(); i--){
    if (isRealStepVisible(i)) return i;
  }
  return null;
}

function updateProgress(){
  const total = totalVisibleSteps();
  // posición visible actual
  let pos = 1;
  if (wiz.idx === 0){
    pos = 1;
  } else {
    // cuenta visibles hasta wiz.idx
    pos = 1;
    for (let i = 1; i <= wiz.idx; i++){
      if (isRealStepVisible(i)) pos++;
    }
  }
  const p = $("wizProgress");
  if (p) p.textContent = `Paso ${pos} de ${total}`;
}

function updateStepUI(focus){
  // Mostrar/ocultar la sección de filiación fuera del wizard
  const bf = document.getElementById("boxFiliacion");
  if (bf) bf.classList.toggle("isHidden", wiz.idx !== 0);

  // Pasos dinámicos
  for (let i=0;i<wiz.steps.length;i++){
    const realIdx = i+1;
    const isActive = (wiz.idx === realIdx);
    wiz.steps[i].el.classList.toggle("isActive", isActive);
  }

  // Botones
  const prev = $("btnPrev");
  const next = $("btnNext");
  const fin = $("btnFinish");

  const hasPrev = prevVisibleReal(wiz.idx) !== null;
  prev.disabled = !hasPrev;

  const hasNext = nextVisibleReal(wiz.idx) !== null;
  next.style.display = hasNext ? "inline-block" : "none";
  fin.style.display = hasNext ? "none" : "inline-block";

  updateProgress();

  if (focus){
    try{
      if (wiz.idx > 0){
        const s = wiz.steps[wiz.idx-1];
        if (s && s.inputEl) s.inputEl.focus();
      }
    }catch(_){ }
  }
}

function validateCurrentStep(){
  setStatus("");

  if (wiz.idx === 0){
    // Validación mínima: nombre y apellidos opcional; solo token obligatorio en final.
    return true;
  }

  const s = wiz.steps[wiz.idx-1];
  if (!s) return true;

  // Para selects/datos básicos: no forzamos salvo campos críticos.
  // Si quieres hacer obligatorios, aquí es donde se marca.
  return true;
}

function goTo(realIdx){
  wiz.idx = realIdx;
  updateStepUI(true);
}

$("btnPrev").addEventListener("click", ()=>{
  const p = prevVisibleReal(wiz.idx);
  if (p !== null) goTo(p);
});

$("btnNext").addEventListener("click", ()=>{
  if (!validateCurrentStep()) return;
  const n = nextVisibleReal(wiz.idx);
  if (n !== null) goTo(n);
});

$("btnFinish").addEventListener("click", async ()=>{
  await saveFinal();
});

// =============================
// Objetos modal (se mantiene)
// =============================
function updateObjsCount(){
  const n = objetosState.length;
  const el = $("objsCount");
  if (el) el.textContent = String(n);
  const el2 = $("q_objCount");
  if (el2) el2.textContent = String(n);
}

function openObjs(){
  renderObjs();
  const b = $("objsBack");
  if (b) b.style.display = "flex";
}
function closeObjs(){
  const b = $("objsBack");
  if (b) b.style.display = "none";
}

function renderObjs(){
  const list = $("objsList");
  if (!list) return;
  list.innerHTML = "";

  if (!objetosState.length){
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "Sin objetos.";
    list.appendChild(empty);
    return;
  }

  objetosState.forEach((o, idx)=>{
    const row = document.createElement("div");
    row.style.display = "grid";
    row.style.gridTemplateColumns = "1fr 120px 140px 44px";
    row.style.gap = "8px";

    const tipoI = document.createElement("input");
    tipoI.placeholder = "Tipo";
    tipoI.value = o.tipo || "";
    tipoI.addEventListener("input", ()=>{ o.tipo = tipoI.value; });

    const cantI = document.createElement("input");
    cantI.placeholder = "Cantidad";
    cantI.inputMode = "numeric";
    cantI.value = o.cantidad || "";
    cantI.addEventListener("input", ()=>{ o.cantidad = cantI.value; });

    const valI = document.createElement("input");
    valI.placeholder = "Valor (€)";
    valI.inputMode = "numeric";
    valI.value = o.valor || "";
    valI.addEventListener("input", ()=>{ o.valor = valI.value; });

    const del = document.createElement("button");
    del.className = "btn danger";
    del.type = "button";
    del.textContent = "X";
    del.addEventListener("click", ()=>{
      objetosState.splice(idx, 1);
      renderObjs();
      updateObjsCount();
    });

    row.appendChild(tipoI);
    row.appendChild(cantI);
    row.appendChild(valI);
    row.appendChild(del);
    list.appendChild(row);
  });
}

$("btnCloseObjs").addEventListener("click", closeObjs);
$("objsBack").addEventListener("click", (e)=>{ if (e.target === $("objsBack")) closeObjs(); });

$("btnAddObj").addEventListener("click", ()=>{
  objetosState.push({ tipo:"", cantidad:"", valor:"" });
  renderObjs();
  updateObjsCount();
});

$("btnSaveObjs").addEventListener("click", ()=>{
  objetosState = objetosState.filter(o => (o.tipo||"").trim() || (o.cantidad||"").trim() || (o.valor||"").trim());
  updateObjsCount();
  closeObjs();
});

// =============================
// Guardado / carga
// =============================
async function saveFinal(){
  try{
    if (!token){ alert("Falta token en la URL."); return; }

    const p = buildPayload();

    try{
      const outLocal = { estado:"FINALIZADA", ...p };
      localStorage.setItem(storageKey(), JSON.stringify(outLocal));
    }catch(_){ }

    const ref = doc(db, "predenuncias", token);

    await setDoc(ref, {
      estado: "FINALIZADA",
      tipo,
      token,
      filiacion: p.filiacion,
      hechos: p.hechos,
      createdAt: serverTimestamp(),
      finalizedAt: serverTimestamp()
    }, { merge: true });

    const msg = $("doneMsg");
    if (msg) msg.style.display = "block";
    alert("Formulario finalizado.");

  }catch(err){
    const m = (err && err.message) ? err.message : String(err);
    alert("ERROR AL FINALIZAR: " + m);
  }
}

function loadIfAny(){
  const raw = localStorage.getItem(storageKey());
  if (!raw) return;
  try{
    const x = JSON.parse(raw);

    // Filiación
    const f = x.filiacion || {};
    $("fNombre").value = f["Nombre"]||"";
    $("fApellidos").value = f["Apellidos"]||"";
    $("fTipoDoc").value = f["Tipo de documento"]||"DNI";
    $("fNumDoc").value = f["Nº Documento"]||"";
    $("fNac").value = f["Nacionalidad"]||"";
    $("fNacFecha").value = f["Fecha de nacimiento"]||"";
    $("fNacLugar").value = f["Lugar de nacimiento"]||"";
    $("fDom").value = f["Domicilio"]||"";
    $("fTel").value = f["Teléfono"]||"";

    // Hechos
    const h = x.hechos || {};
    wiz.st.calidad_denunciante = h.calidad_denunciante || "";
    wiz.st.conocimiento_hecho = h.conocimiento_hecho || "";
    wiz.st.fecha = h.fecha || "";
    wiz.st.hora = h.hora || "";
    wiz.st.lugar = h.lugar || "";
    wiz.st.interaccion_autor = h.interaccion_autor || "";
    wiz.st.autor_retenido = h.autor_retenido || "";
    wiz.st.lesiones = h.lesiones || "NO";
    wiz.st.parte_medico = h.parte_medico || "NO";
    wiz.st.camaras = h.camaras || "NO";
    wiz.st.camaras_detalle = h.camaras_detalle || "";
    wiz.st.resumen = h.resumen || "";

    objetosState = Array.isArray(h.objetos) ? h.objetos.slice() : [];
    updateObjsCount();

  }catch(_){ }
}

// INIT
renderWizard();
loadIfAny();
renderWizard();
renderNacPills();
updateObjsCount();

// Si hay tipo desconocido, lo dejamos funcionando igualmente.
</script>
</body>
</html>
