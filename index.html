<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#081423">
<link rel="apple-touch-icon" sizes="192x192" href="./icon-192.png">

<title>Panel Policía · Predenuncias</title>
<style>
:root{
  /* Fondo tipo “glass” azul petróleo (IGUAL que Fil.html) */
  --bg0:#081423;
  --bg1:#0b1e2f;
  --bg2:#0a2233;

  /* Superficies */
  --card: rgba(255,255,255,.06);
  --card2:  rgba(255,255,255,.10);

  /* Bordes y texto */
  --edge: rgba(255,255,255,.10);
  --edge2: rgba(255,255,255,.14);
  --txt: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.62);

  /* Acentos */
  --acc:#3b82f6;
  --ok:#22c55e;
  --warn:#f59e0b;
  --danger:#ef4444;

  /* Labels (dorado) */
  --label:#d6b06a;
}

*{box-sizing:border-box}
[hidden]{display:none !important}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--txt);
  background:
   radial-gradient(1200px 700px at 20% -10%, rgba(10,132,255,.18), transparent 60%),
      radial-gradient(900px 600px at 90% 10%, rgba(52,199,89,.10), transparent 55%),
      linear-gradient(180deg, #0b0f14, #0a0d12);
  min-height:100vh;
}

.wrap{max-width:1050px;margin:0 auto;padding:22px 16px 26px}

.top{
  display:grid;
  grid-template-columns:1fr;
  gap:16px;
  align-items:start;
  margin-bottom:14px;
}

/* ===== BASE BOTONES ===== */
.btn{
  border:1px solid var(--edge);
  border-radius:12px;
  padding:16px 14px;
  background:rgba(59,130,246,.20);
  color:var(--label);
  font-weight:800;
  letter-spacing:.3px;
  cursor:pointer;
}
.btn:active{transform:translateY(1px)}

.btn.secondary{background:rgba(255,255,255,.06);color:var(--label)}
.btn.small{padding:10px 12px;border-radius:10px;font-weight:800;color:var(--label)}

/* ===== BOTONES TIPO PÍLDORA ===== */
.btn.pill{
  border-radius:999px;
  padding:12px 26px;
  font-weight:900;
  background:transparent;
}

.btn.pill.blue{border:1px solid #3b82f6;color:var(--label)}
#btnDownload{
  border:1px solid #ef4444 !important;
}
.btn.pill.green{border:1px solid #22c55e;color:var(--label)}
/* Solo PERSISTIR: borde morado */
#btnPersist{border-color:#55f7f2 !important;}
.btn.pill.gray{border:1px solid rgba(255,255,255,.22);color:var(--label)}
.btn.pill.red{border:1px solid rgba(239,68,68,.65);color:var(--label)}
.btn.pill.soft{background:rgba(255,255,255,.06)}

/* Activo (JSON / DECLARACION) */
.btn.isActive{outline:none;border-color:#22c55e !important}

/* ===== BOTONES CIRCULARES (C/P/X) TRANSPARENTES ===== */
.btn.circle{
  width:36px;
  height:36px;
  border-radius:50%;
  padding:0;
  font-size:14px;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:center;
  background:transparent;
  border:1px solid rgba(255,255,255,.16);
  box-shadow:none;
}
.btn.circle:hover{background:rgba(255,255,255,.06)}

.btn.circle.blue{color:#3b82f6}
.btn.circle.orange{color:#f59e0b}
.btn.circle.red{color:#ef4444}

.swapMark{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:0 8px;
  font-weight:900;
  color:var(--warn);
  user-select:none;
}

/* ===== CARDS (IGUAL que Fil.html) ===== */
.card{
  background:var(--card);
  border:1px solid var(--edge);
  border-radius:18px;
  padding:14px;
  box-shadow:
    0 18px 46px rgba(0,0,0,.35),
    inset 0 1px 0 rgba(255,255,255,.06);
  backdrop-filter:blur(10px) saturate(130%);
  -webkit-backdrop-filter:blur(10px) saturate(130%);
    min-height: calc(100dvh - 140px);
  display: flex;
  flex-direction: column;
}

.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

/* Labels doradas (IGUAL que Fil.html) */
.label{
  font-size:12px;
  color: var(--label);
  letter-spacing:.25px;
  margin:12px 0 8px;
  font-weight:900;
}

.input, textarea{
  width:100%;
  border:1px solid var(--edge2);
  border-radius:14px;
  background:rgba(255,255,255,.06);
  color:var(--txt);
  padding:12px 12px;
  outline:none;
  font-size:13px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
}

.input:focus, textarea:focus{
  border-color: rgba(214,176,106,.55);
  box-shadow:
    0 0 0 3px rgba(214,176,106,.12),
    inset 0 1px 0 rgba(255,255,255,.04);
}

textarea{
  min-height: 340px;
  resize: none;
  flex: 1;
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
}

/* Más aire entre la zona de botones y el área de texto */
#area{margin-top:10px;margin-bottom:16px;}

.main{display:block}
.tokenBox{display:flex;flex-direction:column;gap:10px}
.isHidden{display:none !important}
.topActions{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:14px}

@media (max-width: 720px){
  .wrap{padding:16px 12px 22px}
  textarea{min-height:260px}
  input,
select,
textarea,
.input{
  font-size:16px;}
}

.list{display:flex;flex-direction:column;gap:8px}

.item{
  border:1px solid var(--edge);
  background:rgba(255,255,255,.045);
  border-radius:12px;
  padding:10px 10px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.item:hover{background:rgba(255,255,255,.09)}
.item .left{flex:1; min-width:0}
.item .t{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:800}
.item .metaLine{font-size:12px;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.iconBtn{
  border:1px solid rgba(255,255,255,.07);
  background:rgba(239,68,68,.14);
  color:var(--txt);
  border-radius:10px;
  padding:8px 10px;
  font-weight:900;
  cursor:pointer;
  line-height:1;
}
.iconBtn:hover{background:rgba(239,68,68,.20)}

.iconBtn.secondary{background:rgba(255,255,255,.10)}
.iconBtn.secondary:hover{background:rgba(255,255,255,.16)}

.toolbar{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin:12px 0 0}
.foot{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-top:auto}

.hint{font-size:12px;color:var(--muted);margin-top:8px}
.status{font-size:12px;color:var(--muted);margin-top:10px}

/* ===== LOGIN GATE (password manager friendly) ===== */
.gate{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
  background:rgba(0,0,0,.55);
  z-index:10000;
}
.gateCard{
  width:min(520px, 94vw);
  background:var(--card);
  border:1px solid var(--edge);
  border-radius:18px;
  padding:16px;
  box-shadow:
    0 18px 46px rgba(0,0,0,.35),
    inset 0 1px 0 rgba(255,255,255,.06);
  backdrop-filter:blur(10px) saturate(130%);
  -webkit-backdrop-filter:blur(10px) saturate(130%);
}
.gateTitle{
  font-weight:900;
  letter-spacing:.3px;
  margin-bottom:10px;
}
.gateRow{
  display:flex;
  justify-content:flex-end;
  margin-top:14px;
}

/* modal */
.modalBack{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.78);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:9999;
  overflow:auto; /* CLAVE */
}
.modal{
  width:min(720px, 96vw);
  max-height:calc(100vh - 36px);
  overflow:auto;
  background:rgba(17,28,51,.96);
  border:1px solid var(--edge);
  border-radius:18px;
  padding:14px;
}
.modalHead{display:flex;justify-content:space-between;align-items:center;gap:10px}
.modalTitle{font-weight:900}
.qrWrap{display:flex;gap:14px;align-items:center;flex-wrap:wrap;margin-top:12px}
#qrBox{background:#fff;border-radius:12px;padding:10px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;word-break:break-all}

  /* Fuerza texto en dorado para los títulos que pides */
  #btnLogout,#btnGenToken,#btnViewJson,#btnViewDoc,#btnChatGPT,#btnPersist,#btnDownload{color:var(--label) !important;}
  .card .row > div:first-child{color:var(--label);}
a.btn{display:inline-flex;align-items:center;justify-content:center;text-decoration:none}
</style>
</head>
<body>
<!-- Login overlay (permite al dispositivo guardar credenciales) -->
<div id="loginGate" class="gate" hidden>
  <div class="gateCard">
    <div class="gateTitle">Acceso</div>

    <form id="loginForm" autocomplete="on" method="post" action="#">
      <label class="label" for="loginEmail">Usuario</label>
      <input id="loginEmail" class="input" name="email"
             type="email" inputmode="email"
             autocomplete="username" required />

      <label class="label" for="loginPass">Contraseña</label>
      <input id="loginPass" class="input" name="password"
             type="password"
             autocomplete="current-password" required />

      <div class="gateRow">
        <button class="btn pill blue" id="btnLogin" type="submit">ENTRAR</button>
      </div>
      <div class="status" id="loginStatus"></div>
    </form>
  </div>
</div>
<div id="app" hidden>
<div class="wrap">

  <div class="topActions">
    <button class="btn pill gray" id="btnLogout">SALIR</button>
    <button class="btn pill blue" id="btnGenToken">GENERADOR TOKEN</button>
  </div>

  <div class="main">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        
      </div>
      <div style="height:10px"></div>
      <div id="denList" class="list"></div>
      <div class="status" id="denStatus"></div>

      <div style="height:14px"></div>
      <div style="height:1px;background:var(--edge)"></div>
      <div style="height:14px"></div>

      <div class="row" style="justify-content:space-between">
        
        <div class="mono" id="selectedRef">—</div>
      </div>

      <div class="toolbar">
        <div style="display:flex;flex-direction:column;gap:58px;width:100%">
          
          <!-- Linea 1: centrado JSON ⇄ DECLARACION -->
          <div class="row" style="justify-content:center;width:100%">
            
            <button class="btn pill gray" id="btnViewJson" type="button">JSON</button>
            <strong class="swapMark">⇄</strong>
            <button class="btn pill gray" id="btnViewDoc" type="button">DECLARACION</button>
          </div>

          <!-- Linea 2: pequeños izquierda, ChatGPT derecha -->
          <div class="row" style="justify-content:space-between;width:100%">
            <div class="row" style="flex-wrap:wrap">
              <button class="btn circle blue" id="btnCopy" type="button">C</button>
              <button class="btn circle orange" id="btnPaste" type="button">P</button>
              <button class="btn circle red" id="btnClear" type="button">X</button>
            </div>
            <div class="row" style="justify-content:flex-end;flex:1">
              <button class="btn small secondary" id="btnChatGPT" type="button">CHATGPT</button>
            </div>
          </div>
        </div>
      </div>

      <textarea id="area"></textarea>

      <div class="foot">
        <button class="btn pill green" id="btnPersist" type="button" disabled>PERSISTIR</button>
        <button class="btn pill blue" id="btnDownload" disabled>DESCARGAR</button>
      </div>

      <div class="status" id="workStatus"></div>
    </div>
  </div>
  </div>
</div>


<!-- Modal GRUPO DELICTIVO (selector) -->
<div class="modalBack" id="crimeBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle">Selecciona grupo delictivo</div>
      <button class="btn pill gray" id="btnCloseCrime" type="button">Cerrar</button>
    </div>

    <div class="hint" style="margin-top:10px">Elige el tipo para generar el enlace del denunciante.</div>

    <div class="row" style="margin-top:12px">
      <button class="btn pill gray" data-crime="HURTO_RVI" type="button">HURTO Y RVI</button>
      <button class="btn pill gray" data-crime="ROBO_FUERZA" type="button">ROBO CON FUERZA</button>
      <button class="btn pill gray" data-crime="PATRIMONIO" type="button">COMERCIOS</button>
      <button class="btn pill gray" data-crime="LESIONES" type="button">LESIONES</button>
      <button class="btn pill gray" data-crime="AMENAZAS" type="button">AMENAZAS</button>
      <button class="btn pill gray" data-crime="DAÑOS" type="button">DAÑOS</button>
    </div>
  </div>
</div>

<!-- Modal QR -->
<div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle" id="modalTitle">Acceso denunciante</div>
      <button class="btn pill gray" id="btnCloseModal" type="button">Cerrar</button>
    </div>

    <div class="qrWrap">
      <div id="qrBox" aria-label="QR"></div>
      <div style="flex:1;min-width:260px">
        <div class="label">Link denunciante</div>
        <div class="mono" id="linkOut">—</div>
        <div class="label">Referencia</div>
        <div class="mono" id="refOut">—</div>
        <div class="label">Caduca (purgeAt)</div>
        <div class="mono" id="purgeOut">—</div>
        <div class="row" style="margin-top:10px">
          <button class="btn pill gray" id="btnCopyLink" type="button" disabled>Copiar link</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal EXPORT (fallback sin popups) -->
<div class="modalBack" id="exportBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle">Exportar JSON</div>
      <button class="btn pill gray" id="btnCloseExport" type="button">Cerrar</button>
    </div>

    <div class="row" style="margin-top:12px">
      <a class="btn pill gray" id="exportLink" href="#" rel="noopener">DESCARGAR JSON</a>
      <button class="btn pill gray" id="btnCopyExport" type="button">COPIAR JSON</button>
    </div>

    <textarea id="exportArea" readonly style="margin-top:10px"></textarea>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script type="module">
/* ========= UTIL ========= */
const $ = (id)=>document.getElementById(id);

import { db, serverTimestamp, auth } from "./firebase.js";
import {
  doc,
  setDoc,
  updateDoc,
  deleteDoc,
  getDoc,
  Timestamp,
  collection,
  query,
  where,
  orderBy,
  limit,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import {
  onAuthStateChanged,
  signInWithEmailAndPassword,
  signOut,
  setPersistence,
  browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

function randHex(bytes=16){
  const a = new Uint8Array(bytes);
  crypto.getRandomValues(a);
  return Array.from(a, b=>b.toString(16).padStart(2,"0")).join("");
}
function purgeAtToday2359(){
  const d = new Date();
  d.setHours(23,59,0,0);
  return d.toISOString();
}
async function clipWrite(t){ await navigator.clipboard.writeText(t); }
async function clipRead(){ return await navigator.clipboard.readText(); }
function sanitizeFileName(s){
  return (s||"").trim()
    .replace(/[\\\/:*?"<>|]+/g," ")
    .replace(/\s+/g," ")
    .trim()
    .replace(/\.+$/,"") || "predenuncia";
}
async function resolveDenunciantePage(tipo){
  const C = {
    "HURTO_RVI":   ["denunciante_hurto_rvi.html","hurto_rvi.html","denunciante.html"],
    "ROBO_FUERZA": ["robo_fuerza.html","denunciante_robo_fuerza.html","denunciante.html"],
    "PATRIMONIO":  ["denunciante_patrimonio.html","patrimonio.html","denunciante.html"],
    "LESIONES":    ["denunciante_lesiones.html","lesiones.html","denunciante.html"],
    "AMENAZAS":    ["denunciante_amenazas.html","amenazas.html","denunciante.html"],
    "DAÑOS":       ["denunciante_danos.html","danos.html","denunciante.html"]
  };
  const base = new URL("./", location.href).href;
  const list = C[tipo] || ["denunciante.html"];

  for (const page of list){
    const url = base + page;
    try{
      let r;
      try{ r = await fetch(url, { method:"HEAD", cache:"no-store" }); }
      catch(_){ r = await fetch(url, { method:"GET", cache:"no-store" }); }
      if (r && r.ok) return page;
    }catch(_){ }
  }
  return "denunciante.html";
}

async function buildDenuncianteLink(tipo, token){
  tipo = (tipo || "").toString().trim().toUpperCase();
  const base = new URL("./", location.href).href;
  const page = await resolveDenunciantePage(tipo);
  return base + page + "?tipo=" + encodeURIComponent(tipo) + "&token=" + encodeURIComponent(token);
}

/* ========= ESTADO ========= */
const state = {
  denuncias: [],
  selected: null, // {id, nombre, tipo, filiacion, hechosJson, docText}
  gptUrl: "https://chatgpt.com/g/g-69014d0cf61881918dd3773943228c6b-denupol",

  view: "json", // "json" | "doc"
  dirtyDoc: false
};
function setView(v){
  state.view = (v === "doc") ? "doc" : "json";
  const bj = $("btnViewJson"), bd = $("btnViewDoc");
  if (bj) bj.classList.toggle("isActive", state.view === "json");
  if (bd) bd.classList.toggle("isActive", state.view === "doc");
  renderSelectedIntoArea();
  refreshActions();
}

function renderSelectedIntoArea(){
  const a = $("area");
  if (!a) return;
  if (!state.selected){
    a.value = "";
    return;
  }
  if (state.view === "json"){
    a.value = JSON.stringify(state.selected.hechosJson || {}, null, 2);
    a.readOnly = true;
  } else {
    a.value = (state.selected.docText || "");
    a.readOnly = false;
  }
}


/* ========= FIRESTORE: LISTENER (predenuncias finalizadas) ========= */
function startFirestoreListener(){
  const q = query(
    collection(db, "predenuncias"),
    where("estado", "==", "FINALIZADA"),
    orderBy("finalizedAt", "desc"),
    limit(50)
  );

  return onSnapshot(q, (snap)=>{
    const out = [];
    snap.forEach((d)=>{
      const x = d.data() || {};
      const f = x.filiacion || {};
      const nombre = (`${f["Nombre"]||""} ${f["Apellidos"]||""}`).trim() || d.id;
      out.push({
        id: d.id,
        tipo: (x.tipo || x.crimeType || "").toString().toUpperCase() || "PATRIMONIO",
        nombre,
        filiacion: f,
        hechosJson: (x.hechos || {}),
        docText: (x.docText || x.doc || ""),
        finalizedAt: x.finalizedAt || null
      });
    });

    state.denuncias = out;
    renderDenuncias();
    $("denStatus").textContent = "";
    if (state.selected){
      const nx = out.find(z=>z.id===state.selected.id);
      if (nx){ state.selected = nx; renderSelectedIntoArea(); }
    }
  }, (err)=>{
    console.warn("onSnapshot predenuncias error", err);
    const m = (err && err.message) ? err.message : String(err);
    $("denStatus").textContent = "ERROR Firebase: " + m;
  });
}

/* ========= UI: DENUNCIAS LIST ========= */
function renderDenuncias(){
  const box = $("denList");
  box.innerHTML = "";
  if (!state.denuncias.length){
    $("denStatus").textContent = "";
    return;
  }
  $("denStatus").textContent = "";
  for (const d of state.denuncias){
    const el = document.createElement("div");
    el.className = "item";

    const left = document.createElement("div");
    left.className = "left";
    left.innerHTML = `<div class="t">${escapeHtml(d.nombre)}</div>`;
    el.appendChild(left);

    const del = document.createElement("button");
    del.type = "button";
    del.className = "iconBtn";
    del.title = "Eliminar";
    del.textContent = "X";
    del.addEventListener("click", async (ev)=>{
      ev.stopPropagation();
      const ok = confirm("¿Eliminar esta denuncia?");
      if (!ok) return;
      try{
        await deleteDoc(doc(db, "predenuncias", d.id));
        if (state.selected && state.selected.id === d.id){
          state.selected = null;
          $("selectedRef").textContent = "—";
          $("area").value = "";
          refreshActions();
        }
      }catch(err){
        const m = (err && err.message) ? err.message : String(err);
        alert("ERROR al eliminar: " + m);
      }
    });
    el.appendChild(del);

    el.addEventListener("click", ()=>selectDenuncia(d.id));
    box.appendChild(el);
  }
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function selectDenuncia(id){
  const d = state.denuncias.find(x=>x.id===id);
  if (!d) return;
  state.selected = d;
  state.dirtyDoc = false;

  $("selectedRef").textContent = d.nombre;
  $("workStatus").textContent = "";
  renderSelectedIntoArea();
  refreshActions();
}

/* ========= UI: ACTION BUTTONS ========= */
function refreshActions(){
  const hasSel = !!state.selected;
  const a = $("area");
  const txt = (a && a.value) ? a.value.trim() : "";

  const persistedDoc = (state.selected && state.selected.docText) ? String(state.selected.docText).trim() : "";
  const effectiveDoc = (state.view === "doc") ? txt : persistedDoc;

  const bp = $("btnPersist");
  // PERSISTIR debe estar disponible siempre que haya selección y estemos en vista DECLARACION,
  // aunque el texto esté vacío o no se haya tocado el área.
  if (bp) bp.disabled = !(hasSel && state.view === "doc");

  const bjson = $("btnCopyFinalJson");
  if (bjson) bjson.disabled = true; // oculto; no se usa
  $("btnDownload").disabled = !hasSel;
}
$("area").addEventListener("input", ()=>{
  // Mantenemos dirtyDoc por si lo quieres usar para UI, pero ya no bloquea PERSISTIR.
  if (state.view === "doc") state.dirtyDoc = true;
  refreshActions();
});
$("btnViewJson").addEventListener("click", ()=> setView("json"));
$("btnViewDoc").addEventListener("click", ()=> setView("doc"));

$("btnPersist").addEventListener("click", async ()=>{
  if (!state.selected) return;
  if (state.view !== "doc") return;
  const docTxt = ("area" in $ ? $("area").value : ($("area").value)) || "";
  // No hacemos trim(): permitimos persistir incluso vacío y respetamos saltos/espacios.
  try{
    await updateDoc(doc(db, "predenuncias", state.selected.id), {
      docText: docTxt,
      docUpdatedAt: serverTimestamp()
    });
    state.selected.docText = docTxt;
    state.dirtyDoc = false;
    $("workStatus").textContent = "";
    refreshActions();
  }catch(err){
    const m = (err && err.message) ? err.message : String(err);
    alert("ERROR al persistir: " + m);
  }
});

$("btnCopy").addEventListener("click", async ()=>{
  const t = $("area").value || "";
  await clipWrite(t);
  $("workStatus").textContent = "";
});

$("btnPaste").addEventListener("click", async ()=>{
  $("area").value = await clipRead();
  refreshActions();
  $("workStatus").textContent = "";
});

$("btnClear").addEventListener("click", ()=>{
  $("area").value = "";
  refreshActions();
  $("workStatus").textContent = "";
});

$("btnChatGPT").addEventListener("click", ()=>{
  window.open(state.gptUrl, "_blank", "noopener");
});

const __btnCopyFinalJson = $("btnCopyFinalJson");
if (__btnCopyFinalJson){
  __btnCopyFinalJson.addEventListener("click", async ()=>{
    if (!state.selected) return;

    const doc = ($("area").value || "").trim();
    if (!doc){ alert("El área está vacía."); return; }

    const finalJson = {
      doc,
      filiaciones: [ state.selected.filiacion ]
    };

    await clipWrite(JSON.stringify(finalJson, null, 2));
    $("workStatus").textContent = "";
  });
}

$("btnDownload").addEventListener("click", async ()=>{
  try{
    if (!state.selected) return;

    const inArea = ($("area").value || "").trim();
    const persistedDoc = (state.selected && state.selected.docText) ? String(state.selected.docText).trim() : "";
    const docText = (state.view === "doc") ? inArea : persistedDoc;
    // Permitimos exportar aunque esté vacío (doc: "").

    const finalJson = { doc: (docText || ""), filiaciones: [ state.selected.filiacion ] };
    const nombre = sanitizeFileName(`${state.selected.filiacion["Nombre"]||""} ${state.selected.filiacion["Apellidos"]||""}`) + ".json";
    const jsonText = JSON.stringify(finalJson, null, 2);
    const blob = new Blob([jsonText], {type:"application/json;charset=utf-8"});

    // 1) Móvil: Share API
    if (navigator.canShare){
      try{
        const file = new File([blob], nombre, {type:"application/json"});
        if (navigator.canShare({ files: [file] })){
          await navigator.share({ files:[file], title:nombre, text:"JSON para COMPAPOL" });
          return;
        }
      }catch(e){ /* ignore and continue */ }
    }

    // 2) PC: selector de ubicación (Save As)
    if (window.showSaveFilePicker){
      try{
        const handle = await window.showSaveFilePicker({
          suggestedName: nombre,
          types: [{ description: "JSON", accept: { "application/json": [".json"] } }]
        });
        const w = await handle.createWritable();
        await w.write(blob);
        await w.close();
        return;
      }catch(e){ /* cancelado o no permitido */ }
    }

    // 3) Fallback sin popups: modal con descarga manual + copiar
    const url = URL.createObjectURL(blob);
    openExportModal(url, jsonText, nombre);

  }catch(err){
    const msg = (err && err.message) ? err.message : String(err);
    alert("ERROR DESCARGAR: " + msg);
  }
});

/* ========= GENERADOR TOKEN + MODAL QR ========= */
let qr = null;
function openModal(){ $("modalBack").style.display = "flex"; }
function closeModal(){ $("modalBack").style.display = "none"; }
$("btnCloseModal").addEventListener("click", closeModal);
$("modalBack").addEventListener("click", (e)=>{ if (e.target === $("modalBack")) closeModal(); });

let __exportUrl = null;
function openExportModal(url, jsonText, filename){
  __exportUrl = url;
  const link = $("exportLink");
  const area = $("exportArea");
  link.href = url;
  link.setAttribute("download", filename);
  area.value = jsonText;
  $("exportBack").style.display = "flex";
}
function closeExportModal(){
  $("exportBack").style.display = "none";
  if (__exportUrl){
    try{ URL.revokeObjectURL(__exportUrl); }catch(e){}
    __exportUrl = null;
  }
}
$("btnCloseExport").addEventListener("click", closeExportModal);
$("exportBack").addEventListener("click", (e)=>{ if (e.target === $("exportBack")) closeExportModal(); });
$("btnCopyExport").addEventListener("click", async ()=>{ await clipWrite($("exportArea").value || ""); });

function renderQR(text){
  $("qrBox").innerHTML = "";
  qr = new QRCode($("qrBox"), { text, width: 190, height: 190 });
}


function openCrimeModal(){ $("crimeBack").style.display = "flex"; }
function closeCrimeModal(){ $("crimeBack").style.display = "none"; }

$("btnGenToken").addEventListener("click", openCrimeModal);
$("btnCloseCrime").addEventListener("click", closeCrimeModal);
$("crimeBack").addEventListener("click", (e)=>{ if (e.target === $("crimeBack")) closeCrimeModal(); });

async function generateTokenFor(tipo){
  tipo = (tipo || "").trim().toUpperCase();
  if (!tipo) return;

  const token = randHex(16);
  const id = `P-${Date.now()}-${Math.floor(Math.random()*10000)}`;
  const purgeAt = purgeAtToday2359();
  const link = await buildDenuncianteLink(tipo, token);

  // Crea la sesión del token en Firestore para que el denunciante pueda FINALIZAR
  // expiresAt debe ser Timestamp (no string)
  try{
    await setDoc(doc(db, "tokenSessions", token), {
      crimeType: tipo,
      revoked: false,
      createdAt: serverTimestamp(),
      expiresAt: Timestamp.fromMillis(Date.now() + 5*60*1000)
    }, { merge: false });
  }catch(e){
    console.warn("No se pudo crear tokenSessions/"+token, e);
  }

  $("modalTitle").textContent = "Acceso denunciante · " + tipo;
  $("linkOut").textContent = link;
  $("refOut").textContent = id;
  $("purgeOut").textContent = purgeAt;
  $("btnCopyLink").disabled = false;

  renderQR(link);
  openModal();
}

// Wiring: botones del modal de grupos delictivos
document.querySelectorAll('#crimeBack [data-crime]').forEach((b)=>{
  b.addEventListener('click', async ()=>{
    const tipo = b.getAttribute('data-crime') || '';
    closeCrimeModal();
    await generateTokenFor(tipo);
  });
});

$("btnCopyLink").addEventListener("click", async ()=>{
  const t = $("linkOut").textContent || "";
  if (t && t !== "—") await clipWrite(t);
});


$("btnLogout").addEventListener("click", async ()=>{
  try{ await signOut(auth); }catch(_){ }
});

/* ========= INIT (AUTH-GATED) ========= */
const appRoot = document.getElementById("app");
let __unsubPred = null;
const gate = document.getElementById("loginGate");
const loginForm = document.getElementById("loginForm");
const loginStatus = document.getElementById("loginStatus");

function showGate(){
  if (gate) gate.hidden = false;
  if (loginStatus) loginStatus.textContent = "";
  try{ document.getElementById("loginEmail")?.focus(); }catch(_){ }
}
function hideGate(){
  if (gate) gate.hidden = true;
  if (loginStatus) loginStatus.textContent = "";
}

if (loginForm){
  loginForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if (loginStatus) loginStatus.textContent = "";

    const email = (document.getElementById("loginEmail")?.value || "").trim();
    const pass = (document.getElementById("loginPass")?.value || "");
    if (!email || !pass) return;

    try{
      await signInWithEmailAndPassword(auth, email, pass);
      // No mostramos el email en UI.
    }catch(err){
      const m = (err && err.message) ? err.message : String(err);
      if (loginStatus) loginStatus.textContent = "ERROR: " + m;
    }
  });
}
// Persistencia de sesión en el dispositivo (recuerda el login)
try{ await setPersistence(auth, browserLocalPersistence); }catch(_){ }


onAuthStateChanged(auth, async (user)=>{
  if (user){
    if (appRoot) appRoot.hidden = false;
    hideGate();
    renderDenuncias();
    refreshActions();
    setView("json");
    if (!__unsubPred) __unsubPred = startFirestoreListener();
  } else {
    if (__unsubPred){ try{ __unsubPred(); }catch(_){ } __unsubPred = null; }
    state.selected = null;
    state.denuncias = [];
    state.view = "json";
    state.dirtyDoc = false;
    try{ const a = $("area"); if (a) a.value = ""; }catch(_){ }
    if (appRoot) appRoot.hidden = true;
    showGate();
  }
});
</script>
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js");
  });
}
</script>
</body>
</html>
